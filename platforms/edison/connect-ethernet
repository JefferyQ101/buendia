#!/bin/bash

set -e
cd $(dirname $0)
ipaddr=192.168.2.15  # Edisons always assign themselves this IP address.

if [ "$1" == "-h" ]; then
  cat <<EOF 1>&2
Usage: $0

Waits for an Edison to appear on the local Ethernet-over-USB network,
then returns the Edison's IP address.
EOF
  exit 1
fi

function wait_for_edison() {
  echo
  echo 'Waiting for the Edison to come up.'
  echo
  if [[ "$OSTYPE" == darwin* ]]; then
    cat <<EOF
If the Edison does not appear within about 60 seconds, open
Network Preferences and look for a new Ethernet device.  Try clicking
the small + at the bottom of the list of network devices and looking
for Multifunction Composite Gadget (enX) in the dropdown list.
Select the new network device.  In the Configure IPv4 dropdown list,
select Manually, set your IP Address to 192.168.2.1, and click Apply.
EOF
  else
    cat <<EOF
If the Edison does not appear within about 60 seconds, open the
Network Connections dialog and click Add and select Ethernet.
In the IPv4 settings, set the address to 192.168.2.1.  Click Save
and choose a name, e.g. Edison.  In the network part of the status
bar (top right) find the device, e.g. Ethernet networks (Edison)
and click the name of the connection type you chose.
EOF
  fi
  echo
  echo -n 'Waiting...'
  while ! ping -c 1 -t 1 $ipaddr > /dev/null; do
    if [[ "$OSTYPE" == linux* ]]; then
      ifconfig usb0 up 192.168.2.1 2>/dev/null || true
    fi
    sleep 1
    echo -n '.'
  done
  echo
  echo "Ready at $ipaddr."
}

# This script is supposed to output the Edison's IP address, so all
# other messages must be sent to stderr.
wait_for_edison 1>&2
echo $ipaddr
