#!/bin/bash

set -e
cd $(dirname $0)
source remote-execution.sh
warfile=$1
root_password=$2
openmrs_user_password=$2

if [ "$1" == "-h" -o ! -n "$openmrs_user_password" ]; then
  echo "Usage: $0 <openmrs.war> <mysql-root-password> <new-mysql-user-password>"
  echo
  echo "Installs OpenMRS on an Edison that already has Tomcat installed."
  exit 1
fi

echo
echo "Installing OpenMRS..."
echo

# Construct the openmrs-runtime.properties file.
function install_runtime_properties() {
  openmrs_user_password="$1"

  cat <<EOF >/tmp/properties
encryption.key=$(dd if=/dev/urandom bs=16 count=1 | base64 | sed -e 's/=/\\=/g')
encryption.vector=$(dd if=/dev/urandom bs=16 count=1 | base64 | sed -e 's/=/\\=/g')

connection.url=jdbc\:mysql\://localhost\:3306/openmrs?autoReconnect\=true&sessionVariables\=storage_engine\=InnoDB&useUnicode\=true&characterEncoding\=UTF-8
connection.username=openmrs_user
connection.password=$openmrs_user_password

auto_update_database=true
module.allow_web_admin=true
EOF

  cat <<EOF | do_in_debian
set -e
mkdir -p /usr/share/tomcat7/.OpenMRS
chown -R tomcat7:root /usr/share/tomcat7/.OpenMRS
EOF
  $scp /tmp/properties $target:/debian/usr/share/tomcat7/.OpenMRS/openmrs-runtime.properties
  rm /tmp/properties
}

# Set up the openmrs_user MySQL user for OpenMRS to use.
function create_openmrs_user() {
  root_password="$1"
  openmrs_user_password="$2"

  cat <<EOF | do_in_debian
set -e
service mysql start
echo "grant all on openmrs.* to openmrs_user@localhost identified by '$openmrs_user_password';" | mysql -uroot -p"$root_password"
echo "grant file on *.* to openmrs_user@localhost;" | mysql -uroot -p"$root_password"
sleep 5
service mysql stop
EOF
}

connect_ethernet
$scp $warfile $target:/debian/var/lib/tomcat7/webapps/openmrs.war
install_runtime_properties "$openmrs_user_password"
create_openmrs_user "$root_password" "$openmrs_user_password"
chmod 755 ../../tools/openmrs_dump
$scp -p ../../tools/openmrs_dump $target:/debian/usr/local/bin
chmod 755 debian/openmrs_backup
$scp -p debian/openmrs_backup $target:/debian/usr/local/bin
