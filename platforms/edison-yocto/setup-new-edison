#!/bin/bash

set -e
cd $(dirname $0)
password=$1
omod_dir=$2
dump_file=$3
site_sql=$4
setup_ssid_psk=$5
production_ssid_psk=$6

if [ "$1" == "-h" -o ! -n "$setup_ssid_psk" ]; then
  echo "Usage: $0 <new-admin-password> <omod-dir> <dump_file.zip> <site.sql> <setup-ssid>[:<psk-password>] [<production-ssid>[:<psk-password>]]"
  echo
  echo "Completely erases and sets up an Edison from scratch, first performing"
  echo "a firmware update and then installing all necessary applications,"
  echo "loading the database from a dump file, and installing OpenMRS modules."
  echo "The root password and all application administrator passwords will be"
  echo "set to <new-admin-password>."
  echo
  echo "<setup-ssid> should be a network with Internet access that the Edison"
  echo "will use during this setup process to download and install software."
  echo "<production-ssid> is the network that the Edison will be configured"
  echo "to join automatically on boot, in production.  Each network can be"
  echo "a wifi network with no password or with a PSK password."
  exit 1
fi

if [[ $omod_dir != /* ]]; then
  echo "Not an absolute path: $omod_dir"
  exit 1
fi

if [ ! -d "$omod_dir" ]; then
  echo "No such directory: $omod_dir"
  exit 1
fi

if [[ $(ls "$omod_dir"/*.omod) == '' ]]; then
  echo "No files found: $omod_dir/*.omod"
  exit 1
fi

if [[ $dump_file != /* ]]; then
  echo "Not an absolute path: $dump_file"
  exit 1
fi

if [ ! -f "$dump_file" ]; then
  echo "No such file: $dump_file"
  exit 1
fi

if [ ! -f "$site_sql" ]; then
  echo "No such file: $site_sql"
  exit 1
fi

# Fetches a file from a URL to a local path.  If the file already exists at
# the local path with the given MD5 hash, skips the fetch.
function fetch_and_cache() {
  url=$1
  dest=$2
  expected_hash=$3
  md5=$(which md5 || which md5sum)

  hash=$($md5 $dest | grep -o '[0-9a-f]\{32\}') || true
  if [ "$hash" != "$expected_hash" ]; then
    curl -o "$dest" -L "$url"
  fi
}

# Get large files from the Internet for now, until we decide where to keep them.
fetchstart=$(date)
fetch_and_cache http://downloadmirror.intel.com/24389/eng/edison-image-rel1-maint-rel1-ww42-14.zip /tmp/edison-firmware.zip 9a7509341cbf936c662af3e46f1b0f34
fetch_and_cache http://sourceforge.net/projects/openmrs/files/releases/OpenMRS_Platform_1.10.1/openmrs.war/download /tmp/openmrs.war 9fcad32a937bc433e4e866c56428b8be

start=$(date)
./replace-firmware /tmp/edison-firmware.zip
flashed=$(date)
./configure-root-access "$password"
./configure-hostname
./connect-wifi "$setup_ssid_psk"
./install-debian
./install-packages "$password"
./install-openmrs /tmp/openmrs.war "$password" "$password"
./install-omods $omod_dir
./install-push-clock
./load-database "$dump_file" openmrs "$password"
./load-sql "$site_sql" openmrs "$password"
./enable-services
finish=$(date)
./reboot
# We aren't using DHCP yet.
# ./verify-dhcp
./verify-buendia
up=$(date)
if [ -n "$production_ssid_psk" ]; then
  ./connect-wifi "$production_ssid_psk" >/dev/null 2>/dev/null
fi

echo "$fetchstart - start downloading firmware & openmrs.war"
echo "$start - start writing firmware"
echo "$flashed - finished writing firmware"
echo "$finish - reboot"
echo "$up - server responding"
echo
