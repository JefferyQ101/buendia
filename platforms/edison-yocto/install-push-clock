#!/bin/bash

# TODO(kpy): Remove push_clock and this installation script when we have
# a better way to ensure that the Edison's clock keeps correct time.

set -e
cd $(dirname $0)
source remote-execution.sh

if [ "$1" == "-h" ]; then
  echo "Usage: $0"
  echo
  echo "Installs /usr/local/bin/push_clock on the Edison as setuid root."
  exit 1
fi

function disable_home_nosuid() {
  cat << EOF | do_in_yocto
set -e

# Remove the "nosuid" option from the /home mount entry in fstab.
grep -v /home /etc/fstab > /tmp/fstab.$$
grep /home /etc/fstab | sed -e 's/,nosuid,/,/' >> /tmp/fstab.$$
cp /tmp/fstab.$$ /etc/fstab

# Remount /home according to fstab.
mount -o remount /home
EOF
}

function compile_push_clock() {
  $scp debian/push_clock.c $target:/debian/root
  cat <<EOF | do_in_debian
set -e
apt-get -y install gcc libc-dev
gcc -o /usr/local/bin/push_clock push_clock.c
chmod u+s /usr/local/bin/push_clock
ls -al /usr/local/bin/push_clock
EOF
}

disable_home_nosuid
compile_push_clock
