#!/bin/bash

# Installs MySQL.

set -e
password=$1

if [ ! -n "$password" ]; then
  echo "Usage: $0 <new-mysql-root-password>"
  exit 1
fi

function install_mysql_server() {
  new_password="$1"

  echo "mysql-server-5.5 mysql-server/root_password password $new_password" | debconf-set-selections
  echo "mysql-server-5.5 mysql-server/root_password_again password $new_password" | debconf-set-selections

  # -y bypasses confirmation prompts from APT.
  apt-get install -y mysql-server-5.5
}

# Creates the user for dumping and loading database data.
function create_dump_user() {
  root_password="$1"
  dump_user_password="$2"

  service mysql start

  # The first grant below implicitly creates the dump@localhost user.
  # SELECT and FILE privileges are needed to dump data to disk.  DROP,
  # CREATE, and INSERT privileges are needed to load data into a database.
  # FILE privilege can only be granted to *.*, not a specific database.
  cat <<EOF | mysql -uroot -p"$root_password"
grant file on *.* to dump@localhost identified by '$dump_user_password';
grant select, drop, create, insert on *.* to dump@localhost;
grant create temporary tables, update, delete on *.* to dump@localhost;
EOF

  # Debian scripts should bring down their services so as to not conflict
  # with yocto scripts.
  service mysql stop
}

install_mysql_server "$password"
create_dump_user "$password" "$password"
