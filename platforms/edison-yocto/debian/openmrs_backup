#!/bin/bash

export MYSQL_USER=$(grep connection.username /usr/share/tomcat7/.OpenMRS/openmrs-runtime.properties | sed -e 's/.*connection.username=//')
export MYSQL_PASSWORD=$(grep connection.password /usr/share/tomcat7/.OpenMRS/openmrs-runtime.properties | sed -e 's/.*connection.password=//')

# Only perform the backup if the SD card can be mounted.
if [ -d /var/backups/large ]; then
  # Granularity is one hour, so we keep at most one per hour.
  date=$(date +"%Y-%m-%d.%H")
  dest=/var/backups/large/$date.zip
  rm -f /var/backups/large/*.new.*
  /usr/local/bin/openmrs_dump openmrs $dest.new.$$ && mv $dest.new.$$ $dest
  sync
fi
