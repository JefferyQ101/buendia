#!/bin/bash

# Installs Tomcat.

set -e
password=$1

if [ ! -n "$password" ]; then
  echo "Usage: $0 <new-tomcat-admin-password>"
  exit 1
fi

function install_jdk7() {
  apt-get -y install openjdk-7-jdk
  update-alternatives --config java
  ln -sf /usr/lib/jvm/java-7-openjdk-i386 /usr/lib/jvm/default-java
}

function install_tomcat7() {
  apt-get -y install tomcat7 tomcat7-admin
}

function create_admin_user() {
  new_password="$1"

  grep -v '</tomcat-users' /etc/tomcat7/tomcat-users.xml > /tmp/tomcat-users.xml
  cat <<EOF >> /tmp/tomcat-users.xml
<user username="admin" password="$new_password" roles="manager-gui" />
</tomcat-users>
EOF
  mv /tmp/tomcat-users.xml /etc/tomcat7/tomcat-users.xml
}

function adjust_java_opts() {
  filename=/etc/default/tomcat7

  # Increase memory limit from Xmx128m to Xmx256m.
  # Add the CMSIncrementalMode option.
  sed 's/^ *JAVA_OPTS.*/JAVA_OPTS="-Djava.awt.headless=true -Xmx256m -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode"/' $filename > $filename.new
  mv $filename.new $filename
}

install_jdk7  # JDK 7 is required
install_tomcat7
create_admin_user "$password"
adjust_java_opts

# Debian scripts should stop the services they install so as not to conflict
# with yocto setup scripts.
service tomcat7 stop
