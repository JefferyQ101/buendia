#!/bin/bash

# Installs Tomcat.

set -e
password=$1

if [ ! -n "$password" ]; then
  echo "Usage: $0 <new-tomcat-admin-password>"
  exit 1
fi

function install_jdk7() {
  apt-get -y install openjdk-7-jdk
  update-alternatives --config java
  ln -sf /usr/lib/jvm/java-7-openjdk-i386 /usr/lib/jvm/default-java
}

function install_tomcat7() {
  apt-get -y install tomcat7 tomcat7-admin
}

function create_admin_user() {
  new_password="$1"

  grep -v '</tomcat-users' /etc/tomcat7/tomcat-users.xml > /tmp/tomcat-users.xml
  cat <<EOF >> /tmp/tomcat-users.xml
<user username="admin" password="$new_password" roles="manager-gui" />
</tomcat-users>
EOF
  mv /tmp/tomcat-users.xml /etc/tomcat7/tomcat-users.xml
}

function adjust_java_opts() {
  f="/etc/default/tomcat7"
  old="-Djava.awt.headless=true -Xmx128m -XX:+UseConcMarkSweepGC"
  new="-Djava.awt.headless=true -Xmx256m -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode"

  #Replace string and remove old file.
  sed "s/$old/$new/g" $f > $f.new
  mv $f.new $f
  echo $f done
}

install_jdk7  # JDK 7 is required
install_tomcat7
create_admin_user "$password"
adjust_java_opts

# Debian scripts should stop the services they install so as not to conflict
# with yocto setup scripts.
service tomcat7 stop
