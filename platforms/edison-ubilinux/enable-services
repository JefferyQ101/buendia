#!/bin/bash

set -e
cd $(dirname $0)
source remote-execution.sh

if [ "$1" == "-h" ]; then
  echo "Usage: $0"
  echo
  echo "Configures services to run on startup."
  exit 1
fi

echo
echo "Configuring services to run on startup..."
echo

$scp yocto/*.service yocto/*.timer $target:/etc/systemd/system

cat <<EOF | do_in_yocto
# Pick up the new service configurations.
systemctl daemon-reload

# debian-mounts.service causes /dev, /proc, and /sys to be mounted inside
# the Debian chroot directory.  Services that run in Debian must specify
# After=debian-mounts.service so that these mounts are done before they start.
# If they do not, there is a risk that multiple services will concurrently
# attempt to mount these special directories, which results in mayhem.
systemctl enable debian-mounts.service

# We aren't using dnsmasq yet.
# systemctl enable dnsmasq.service

# Make MySQL and Tomcat 7 start automatically on boot.
systemctl enable mysql.service
systemctl enable tomcat7.service

# Warm up OpenMRS every few minutes, starting shortly after boot.
systemctl enable openmrs-warmup.timer

# Start up all the services to confirm that they can start successfully.
systemctl restart mysql.service
systemctl restart tomcat7.service
systemctl restart openmrs-warmup.timer
EOF
