#!/bin/bash

mkdir -p /usr/share/buendia/site
SETTINGS=/usr/share/buendia/site/mysql
INITSQL=/tmp/buendia-mysql-init.sql
CONF=/etc/mysql/conf.d/buendia-init.cnf

# Generate a random MySQL root password if one is not already set.
if [ ! -f $SETTINGS ]; then
    password=$(buendia-mkpass)
    echo "MYSQL_ROOT_PASSWORD=$password" > $SETTINGS
fi

# Read the settings.
. $SETTINGS

# Create a MySQL initialization file that sets the root password.
umask 066
cat <<EOF >$INITSQL
update mysql.user set password=password('$MYSQL_ROOT_PASSWORD') where user='root';
flush privileges;
EOF
chgrp mysql $INITSQL
chmod g+r $INITSQL

# Configure MySQL to run the initialization file on startup.
cat <<EOF >$CONF
[mysqld]
init_file=$INITSQL
EOF

# Make MySQL restart and execute the initialization file.
service mysql restart

# Clean up and restart again under normal conditions.
rm -f $INITSQL $CONF
service mysql restart
