#!/bin/bash

set -e
. /usr/share/buendia/site/pkgclient

(
    if ! flock -n 9; then
        echo "buendia-pkgclient-update already running; not starting."
        exit 1
    fi

    export DEBIAN_FRONTEND=noninteractive

    # Update the package list.
    apt-get update || true

    # Fix up any broken things.
    dpkg --configure -a || true
    apt-get -y -f install || true

    # Install and upgrade all the Buendia packages.
    packages=$(echo $(cat /usr/share/buendia/packages.list.d/*))
    apt-get -y --allow-unauthenticated install $packages || true

    if [ -f /var/run/reboot-required ]; then
        echo "One or more packages have indicated that a reboot is required!"
    fi
) 9>/var/run/buendia-pkgclient-update.lock
