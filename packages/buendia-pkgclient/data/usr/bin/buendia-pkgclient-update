#!/bin/bash

set -e
. /usr/share/buendia/config.d/pkgclient

(
    if ! flock -n 9; then
        echo
        echo "$(date): buendia-pkgclient-update already running; not starting."
        exit 1
    fi

    echo
    echo "$(date): Starting update."
    export DEBIAN_FRONTEND=noninteractive

    # Update the package list.
    apt-get update || true

    # Fix up any broken things.
    dpkg --configure -a || true
    apt-get -y -f install || true

    # Install and upgrade all the Buendia packages.
    packages=$(echo $(cat /usr/share/buendia/packages.list.d/*))
    apt-get -y --allow-unauthenticated install $packages || true

    echo "$(date): Update complete."

    if [ -f /var/run/reboot-required ]; then
        rm /var/run/reboot-required
        echo "$(date): Rebooting after package installation."
        echo "reboot" | buendia-enter-yocto
    fi

) 9> /var/run/buendia-pkgclient-update.lock
