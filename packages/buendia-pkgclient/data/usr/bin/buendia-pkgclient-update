#!/bin/bash

set -e
. /usr/share/buendia/config.d/pkgclient

echo
echo "$(date): $0"
export DEBIAN_FRONTEND=noninteractive

# Update the package list.
apt-get update || true

# Fix up any broken things.
dpkg --configure -a || true
apt-get -y -f install || true

# Install and upgrade all the Buendia packages.
apt-get -y --allow-unauthenticated install $(cat /usr/share/buendia/packages.list.d/*)

if [ -f /var/run/reboot-required ]; then
    rm /var/run/reboot-required
    echo "$(date): Rebooting after package installation."
    echo "reboot" | buendia-enter-yocto
fi
