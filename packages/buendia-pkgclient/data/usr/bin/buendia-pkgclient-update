#!/bin/bash

set -e; . /usr/share/buendia/utils.sh

if [ "$1" == "-h" ]; then
    echo "Usage: $0 [<package-name>...]"
    echo
    echo "Updates the specified packages, or all the Buendia packages"
    echo "if none are specified.  Does not reboot automatically."
    exit 1
fi

(
    if ! flock -n 9; then
        echo "buendia-pkgclient-update already running; not starting."
        exit 1
    fi

    export DEBIAN_FRONTEND=noninteractive

    # Update the package list.
    apt-get update || true

    # Fix up any broken things.
    dpkg --configure -a || true
    apt-get -y -f install || true

    # Install and upgrade the specified packages, or all the Buendia packages.
    if [ -n "$1" ]; then
        packages=$*
    else
        packages=$(echo $(cat /usr/share/buendia/packages.list.d/*))
    fi
    apt-get -y --allow-unauthenticated install $packages || true

    if [ -f /var/run/reboot-required ]; then
        echo "One or more packages have indicated that a reboot is required!"
    fi
) 9>/var/run/buendia-pkgclient-update.lock
