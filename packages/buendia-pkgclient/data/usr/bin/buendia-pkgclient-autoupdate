#!/bin/bash

set -e; . /usr/share/buendia/utils.sh

if [ "$1" == "-h" ]; then
    echo "Usage: $0"
    echo
    echo "Updates all the Buendia packages, then reboots if necessary."
    echo "This script runs only if /usr/share/buendia/site/pkgclient"
    echo "sets PKGCLIENT_AUTOUPDATE=1."
    exit 1
fi

(
    case "$PKGCLIENT_AUTOUPDATE" in
        ''|0|false|off|no)
            echo "=== $(date): PKGCLIENT_AUTOUPDATE is disabled."
            ;;

        *)
            echo "=== $(date): Starting autoupdate."

            buendia-pkgclient-update

            if [ -f /var/run/reboot-required ]; then
                rm /var/run/reboot-required
                echo "=== $(date): Rebooting after package update."
                echo 'echo "Package installation requires a reboot.  Rebooting in 10 seconds!" | /debian/usr/bin/wall' | buendia-enter-yocto
                sleep 10
                echo "reboot" | buendia-enter-yocto
            else
                echo "=== $(date): Update complete."
            fi
            ;;
    esac
) 2>&1 | tee -a /var/log/buendia-pkgclient-autoupdate.log
