#!/bin/bash

set -e; . /usr/share/buendia/utils.sh

if [ "$1" == "-h" ]; then
    echo "Usage: $0 [-u <seconds>]"
    echo
    echo "Updates all the Buendia packages, then reboots if necessary."
    echo "Performs the update only if /usr/share/buendia/site/pkgclient"
    echo "sets PKGCLIENT_AUTOUPDATE=1."
    echo
    echo "Specify -u <n> to perform the update only after the machine has"
    echo "been up for at least <n> seconds."
    exit 1
fi

(
    if [ "$1" == "-u" ]; then
        min_upsecs="$2"
        upsecs=$(grep -o '[0-9]\+' /proc/uptime | head -1)
        if [ "$upsecs" -lt "$min_upsecs" ]; then
            echo "[$$] === $(date): Not autoupdating: uptime ($upsecs) has not reached $min_upsecs seconds yet."
            exit 1
        fi
    fi

    case "$PKGCLIENT_AUTOUPDATE" in
        ''|0|false|off|no)
            echo "[$$] === $(date): Not autoupdating: PKGCLIENT_AUTOUPDATE is disabled."
            ;;

        *)
            echo "[$$] === $(date): Starting autoupdate."

            buendia-pkgclient-update

            if [ -f /var/run/reboot-required ]; then
                rm /var/run/reboot-required
                echo "[$$] === $(date): Rebooting after package update."
                echo 'echo "Package installation requires a reboot.  Rebooting in 10 seconds!" | /debian/usr/bin/wall' | buendia-enter-yocto
                sleep 10
                echo "reboot" | buendia-enter-yocto
            else
                echo "[$$] === $(date): Update complete."
            fi
            ;;
    esac
) 2>&1 | tee -a /var/log/buendia-pkgclient-autoupdate.log
