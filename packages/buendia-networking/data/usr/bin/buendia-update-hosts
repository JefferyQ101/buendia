#!/bin/bash

# Remove previously added hostnames.
grep -v '# added by buendia' /etc/hosts > /tmp/hosts.$$

# Get the list of names by which this machine wants to be known.
names=$(echo $(hostname) $(ls /usr/share/buendia/names.d/))

# Add a line for each of the machine's IP addresses.
for ip in $(ifconfig | grep -o 'inet addr:[0-9.]\+' | sed -e 's/.*://'); do
    echo "$ip $names # added by buendia" >> /tmp/hosts.$$
done

# Install the new hosts file.
mv /tmp/hosts.$$ /etc/hosts

# Tell dnsmasq to reload the hosts file, if it's running.
if [ -e /var/run/dnsmasq/dnsmasq.pid ]; then
    kill -HUP $(cat /var/run/dnsmasq/dnsmasq.pid)
fi
