#!/bin/bash

set -e
. /usr/share/buendia/utils.sh

tmpfile=/tmp/$(basename $0).$$
trap 'rm -rf $tmpfile' EXIT

# If it's only been a couple of minutes since boot, the server is still coming
# up; don't expect networking to be up yet.
min_upsecs=180
upsecs=$(grep -o '[0-9]\+' /proc/uptime | head -1)
if [ "$upsecs" -lt "$min_upsecs" ]; then
    echo "Not checking wifi: uptime ($upsecs s) has not reached $min_upsecs s yet."
    exit 1
fi

if bool "$NETWORKING_AP"; thn
    echo "Not checking wifi: server is an AP creating its own wifi network."
    exit 1
fi

if [ -z "$NETWORKING_SSID" ]; then
    echo "Not checking wifi: NETWORKING_SSID is unset."
    exit 1
fi

echo 'wpa_cli status' | buendia-enter-yocto >$tmpfile 2>&1

cat $tmpfile  # for the log
# If the state is anything other than "COMPLETED", wifi is down.
if ! grep -q COMPLETED $tmpfile; then
    echo "Restarting wifi."
    # "-f" means to force redoing network setup even though the network
    # configuration settings haven't changed.
    buendia-reconfigure -f networking
fi
