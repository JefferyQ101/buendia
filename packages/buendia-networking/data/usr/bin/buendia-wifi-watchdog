#!/bin/bash

set -e
. /usr/share/buendia/utils.sh

# If it's only been a couple of minutes since boot, the server is still coming
# up; don't expect networking to be up yet.
min_upsecs=180
upsecs=$(grep -o '[0-9]\+' /proc/uptime | head -1)
if [ "$upsecs" -lt "$min_upsecs" ]; then
    echo "Not checking wifi: uptime ($upsecs s) has not reached $min_upsecs s yet."
    exit 1
fi

wpa_state=$(echo 'wpa_cli status' | buendia-enter-yocto | grep wpa_state)

# Check whether wpa_cli produces any output at all.  It will not produce
# output when the server is in AP mode or when the server is not a Yocto
# system -- in both of these situations, we don't want to restart networking.
if [[ -n "$wpa_state" ]]; then
    echo "wpa_cli status: $wpa_state"
    # If the state is anything other than "COMPLETED", wifi is down.
    if [[ "$wpa_state" != *COMPLETED* ]]; then
        echo "Restarting wifi."
        # "-f" means to force redoing network setup even though the network
        # configuration settings haven't changed.
        buendia-reconfigure -f networking
    fi
fi
