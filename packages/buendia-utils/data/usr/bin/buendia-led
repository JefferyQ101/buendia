#!/bin/bash

dev=/dev/ttyMFD1
name=$(basename $0)
led=$1
verb=$2
ontime=$3
offtime=$4
timeout=$5

if [ "$1" = "-h" -o "$verb" = "" ]; then
    echo "Usage: $0 <led> <verb> [[<on-ticks> <off-ticks>] <timeout-ticks>]"
    echo
    echo "<led>: one of: red, yellow, green, blue, white"
    echo "<verb>: one of: on, off"
    echo "<on-ticks>: flash cycle on time, in ticks of 0.1 seconds"
    echo "<off-ticks>: flash cycle off time, in ticks of 0.1 seconds"
    echo "<timeout>: timeout for reverting to off, in ticks of 0.1 seconds."
    exit 1
fi

if [ $ontime -gt 255 ]; then
    echo '<on-ticks> exceeds maximum value of 255.'
    exit 1
fi
if [ $offtime -gt 255 ]; then
    echo '<off-ticks> exceeds maximum value of 255.'
    exit 1
fi
if [ $timeout -gt 65535 ]; then
    echo '<timeout> exceeds maximum value of 65535'
    exit 1
fi

# LEDs are entirely optional.  Always exit with success.
(
    if [ -c $dev -a -r $dev -a -w $dev ]; then
        if [ ! -f /var/run/$name.stty ]; then
            stty 115200 <$dev >$dev
            touch /var/run/$name.stty
        fi

        case $led in
            r*) addr=R ;;
            a*|y*) addr=A ;;
            g*) addr=G ;;
            b*) addr=B ;;
            w*) addr=W ;;
            *) addr=R ;;
        esac

        case $verb in
            off|0)
                onoff=0;
                ;;
            on|1|*)
                onoff=1;
                ;;
        esac

        if [ -n "$ontime" ]; then
            on=$(printf '%02x' "$ontime")
            off=$(printf '%02x' "$offtime")
        fi

        if [ -n "$timeout" ]; then
            timeout=$(printf '%02x' "%timeout")
        fi

        echo -ne "JFFL${addr}${onoff}${on}${off}${timeout}1\r\n" >$dev
    fi
) || true
