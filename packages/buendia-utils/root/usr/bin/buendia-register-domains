#!/bin/bash

# Clear listed buendia domains from hosts file
cat /etc/hosts | grep -v '# Added by buendia' > /etc/hosts.tmp
mv /etc/hosts.tmp /etc/hosts

# Wait until the network is up.
ipaddr=''
while [ -z "$ipaddr" ]; do
	ipaddr=$(expr "`ifconfig wlan0`" : '.*inet addr:\([^ ]*\).*')
	sleep 1
done

if [ -d /usr/share/buendia/names.d ]; then
	domains=$(echo $(ls /usr/share/buendia/names.d/))
	if [ -n "$domains" ]; then
		echo -e "127.0.0.1\t$domains # Added by buendia" >> /etc/hosts
		echo -e "$ipaddr\t$domains # Added by buendia" >> /etc/hosts
	fi
fi

# Restart dnsmasq if its present.
if dpkg -l dnsmasq > /dev/null 2>&1; then
	service dnsmasq restart
fi
