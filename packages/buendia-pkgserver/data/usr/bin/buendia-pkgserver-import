#!/bin/bash

set -e; . /usr/share/buendia/utils.sh
name=$(basename $0)
source="$1"

if [ "$1" = "-h" -o "$source" = "" ]; then
    echo "Usage: $0 [<device>|<directory>]"
    echo
    echo "Imports Buendia package bundles into the local package server."
    echo "Searches for files named projectbuendia-<site>.zip in the given"
    echo "directory or in the root directory of the given mountable device."
    exit 1
fi

exec 9> /var/run/lock/$name
if ! flock -n 9; then
    echo "$name already running; not starting."
    exit 1
fi

# Create temporary directories for mounting and extraction
name=$(basename $0)
mntdir=/tmp/$name.mnt.$$
exdir=/tmp/$name.ex.$$
rm -rf $mntdir $exdir
mkdir $mntdir $exdir
trap 'rm -rf $exdir; umount $mntdir && rm -rf $mntdir || rmdir $mntdir' EXIT

# Mount the given device to a temporary directory.
if [ -b "$source" ]; then
    echo "$source is a block device; mounting..."
    mount $source $mntdir
    source="$mntdir"
elif [ -d "$source" ]; then
    echo "$source is a directory; scanning..."
else
    echo "$source is neither a block device nor a directory."
    exit 1
fi

# Look for all-site updates.
for file in $source/projectbuendia-all{,-*}.zip; do
    if [ -f "$file" ]; then
        echo "Unpacking: $file"
        if unzip -j -d $exdir "$file"; then
            installed="$installed $file"
            unpacked=1
        fi
    fi
done

# Look for site-specific updates.
if [ -n "$SITE_ID" ]; then
    for file in $source/projectbuendia-$SITE_ID{,-*}.zip; do
        if [ -f "$file" ]; then
            echo "Unpacking: $file"
            if unzip -j -d $exdir "$file"; then
                installed="$installed $file"
                unpacked=1
            fi
        fi
    done
fi

# Move the packages into the repo.
if [ -n "$unpacked" ]; then
    count=$(command ls $exdir | wc -l)
    s=s; [ "$count" == 1 ] && s=
    mv $exdir/* /usr/share/buendia/packages/
    echo "Imported $count package$s."

    # Regenerate indexes.
    buendia-pkgserver-index-debs || true
    buendia-pkgserver-index-apks || true
    chmod -R a+rX /usr/share/buendia/packages

    # Mark installed packages done.
    for file in $installed; do
        mv $file "$(dirname "$file")/installed-$(basename "$file")"
    done
else
    echo "No new packages imported."
fi
