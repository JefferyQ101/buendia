#!/bin/bash

set -e; . /usr/share/buendia/utils.sh
name=$(basename $0)
source="$1"

if [ "$1" = "-h" -o "$source" = "" ]; then
    echo "Usage: $0 [<device>|<directory>]"
    echo
    echo "Imports Buendia package bundles into the local package server."
    echo "Searches for files named projectbuendia-<site>.zip in the given"
    echo "directory or in the root directory of the given mountable device."
    exit 1
fi

exec 9> /var/run/lock/$name
if ! flock -n 9; then
    echo "$name already running; not starting."
    exit 1
fi

# Create temporary directories for mounting and extraction.
name=$(basename $0)
mntdir=/tmp/$name.mnt.$$
exdir=/tmp/$name.ex.$$
pkgdir=/usr/share/buendia/packages.import.$$
rm -rf $mntdir $exdir $pkgdir
mkdir $mntdir $exdir $pkgdir
trap 'rm -rf $exdir $pkgdir; umount $mntdir && rm -rf $mntdir || rmdir $mntdir; buendia-led red off || true' EXIT

# Mount the given device to a temporary directory.
if [ -b "$source" ]; then
    echo "$source is a block device; mounting..."
    mount $source $mntdir
    source="$mntdir"
elif [ -d "$source" ]; then
    echo "$source is a directory; scanning..."
else
    echo "$source is neither a block device nor a directory."
    exit 1
fi

# Look for all-site updates.
for file in $source/projectbuendia-all{,-*}.zip; do
    if [ -f "$file" ]; then
        buendia-led red on 4 12 30 || true
        echo "Unpacking: $file"
        if unzip -j -d $exdir "$file"; then
            installed="$installed $file"
            unpacked=1
        fi
    fi
done

# Look for site-specific updates.
if [ -n "$SITE_ID" ]; then
    for file in $source/projectbuendia-$SITE_ID{,-*}.zip; do
        if [ -f "$file" ]; then
            buendia-led red on 4 12 30 || true
            echo "Unpacking: $file"
            if unzip -j -d $exdir "$file"; then
                installed="$installed $file"
                unpacked=1
            fi
        fi
    done
fi

if [ -n "$unpacked" ]; then

    # Move the packages into the repo.
    cp $exdir/*.deb $pkgdir || true
    cp $exdir/*.apk $pkgdir || true
    count=$(command ls $pkgdir | wc -l)

    if [ "$count" -gt 0 ]; then
        buendia-led red on 4 8 10 || true
        s=s; [ "$count" == 1 ] && s=
        mv $pkgdir/* /usr/share/buendia/packages/
        echo "Imported $count package$s."

        # Regenerate indexes.
        buendia-led red on 4 4 60 || true
        buendia-pkgserver-index-debs || true
        buendia-pkgserver-index-apks || true
        chmod -R a+rX /usr/share/buendia/packages
    fi

    # Look for site settings files.
    for file in $exdir/[0-9][0-9]-*; do
        if [ -f "$file" ]; then
            echo "Installing settings file: $file..."
            buendia-led red on 4 8 10 || true
            base="$(basename "$file")"
            target=/usr/share/buendia/site/${base#projectbuendia-}
            cp "$file" "$target"
            chmod 644 $target
            echo "Installed as $target."
            settings_changed=1
        fi
    done

    if [ -n "$settings_changed" ]; then
        echo "Settings changed; reconfiguring."
        buendia-led red on 4 4 10 || true
        buendia-reconfigure
    fi

    # Look for shell commands.
    if [ -f $exdir/commands.sh ]; then
        echo "Executing shell script..."
        buendia-led red on 4 4 10 || true
        touch $exdir/commands.in
        cd $source
        bash -x $exdir/commands.sh <$exdir/commands.in >>commands.log 2>&1 || true
    fi

    # Mark installed packages done.
    for file in $installed; do
        mv $file "$(dirname "$file")/installed-$(basename "$file")"
    done
else
    echo "No files imported."
fi

